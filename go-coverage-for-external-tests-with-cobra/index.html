<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.80.0" />

<link rel="icon" href="/images/favicon.ico">


<title>Go coverage for external tests with Cobra â€“ Steve Leonard</title>



  




<link href="/index.xml" rel="alternate" type="application/rss+xml" title="Steve Leonard" />

<meta property="og:title" content="Go coverage for external tests with Cobra" />
<meta property="og:description" content="Prerequisite reading: Go coverage with external tests
Go coverage can be generated by a CLI tool by compiling it as a test binary and passing it the test coverage flags. There&rsquo;s one catch: coverage will not be generated if the program does not exit with status 0, so its not possible to get coverage for tests of failure cases.
Instructions for generating coverage in this way are described in Go coverage with external tests and won&rsquo;t be repeated here." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.xsleonard.com/go-coverage-for-external-tests-with-cobra/" />
<meta property="article:published_time" content="2019-09-24T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-09-24T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go coverage for external tests with Cobra"/>
<meta name="twitter:description" content="Prerequisite reading: Go coverage with external tests
Go coverage can be generated by a CLI tool by compiling it as a test binary and passing it the test coverage flags. There&rsquo;s one catch: coverage will not be generated if the program does not exit with status 0, so its not possible to get coverage for tests of failure cases.
Instructions for generating coverage in this way are described in Go coverage with external tests and won&rsquo;t be repeated here."/>

<meta itemprop="name" content="Go coverage for external tests with Cobra">
<meta itemprop="description" content="Prerequisite reading: Go coverage with external tests
Go coverage can be generated by a CLI tool by compiling it as a test binary and passing it the test coverage flags. There&rsquo;s one catch: coverage will not be generated if the program does not exit with status 0, so its not possible to get coverage for tests of failure cases.
Instructions for generating coverage in this way are described in Go coverage with external tests and won&rsquo;t be repeated here.">
<meta itemprop="datePublished" content="2019-09-24T00:00:00+00:00" />
<meta itemprop="dateModified" content="2019-09-24T00:00:00+00:00" />
<meta itemprop="wordCount" content="157">



<meta itemprop="keywords" content="software,go,golang,testing," />


<link rel="stylesheet" href="https://www.xsleonard.com/css/main.css" media="all">
<link rel="stylesheet" href="https://www.xsleonard.com/css/fonts.css">

  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="https://www.xsleonard.com/" class="nav-logo">
    <img src="https://www.xsleonard.com/images/portrait.jpg"
         width="50" 
         height="50" 
         alt="Logo">
  </a>
  <a href="https://www.xsleonard.com/" class="nav-title">Steve Leonard</a>

  <ul class="nav-links">
    
    <li><a href="/about/">About</a></li>
    
    <li><a href="/projects/">Projects</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">

    <h1 class="article-title">Go coverage for external tests with Cobra</h1>
    
    <span class="article-date">24 September 2019</span>
    

    <div class="article-content">
      <p><em>Prerequisite reading: <a href="https://blog.cloudflare.com/go-coverage-with-external-tests/">Go coverage with external tests</a></em></p>
<p>Go coverage can be generated by a CLI tool by compiling it as a test binary
and passing it the test coverage flags.
There&rsquo;s one catch: coverage will not be generated if the program does not exit with status 0,
so its not possible to get coverage for tests of failure cases.</p>
<p>Instructions for generating coverage in this way are described in <a href="https://blog.cloudflare.com/go-coverage-with-external-tests/">Go coverage with external tests</a>
and won&rsquo;t be repeated here.</p>
<p>However, if you&rsquo;re using <a href="https://github.com/spf13/cobra">Cobra</a> you need to bind the test flags to <a href="https://github.com/spf13/pflag">pflag</a>
to be able to parse them. During program setup (before calling <code>cobra.Command.Execute</code>), execute the following:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">pflag.CommandLine.<span style="color:#447fcf">AddGoFlagSet</span>(flag.CommandLine)
</code></pre></div><p>And when running the compiled test binary, use <code>--test.coverprofile</code> instead of <code>-test.coverprofile</code>:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">go <span style="color:#24909d">test</span> -coverpkg=<span style="color:#ed9d13">&#34;../../pkg&#34;</span> -c -tags testrunmain mycmd
./mycmd.test --arg1=foo --arg2=bar --test.coverprofile=system.out
</code></pre></div><p>If you&rsquo;re using <a href="https://github.com/urfave/cli">urfave/cli</a>, I wasn&rsquo;t able to find any
way to get the test coverage flags to parse without conflicting with the binary&rsquo;s flags.</p>

    </div>

    <ul class="article-taxonomy">
      

      
      <li>
        <i class="fa fa-tags"></i><a href="/tags/software">software</a><a href="/tags/go">go</a><a href="/tags/golang">golang</a><a href="/tags/testing">testing</a>
      </li>
      
  </article>

</main>

      <footer class="footer">
        <ul class="footer-links">
          
          <li>
            <a href="mailto:xsleonard@gmail.com"><i class="fa fa-email"></i> Email</a>
          </li>
          
          
          <li>
            <a href="https://github.com/xsleonard"><i class="fa fa-github"></i> GitHub</a>
          </li>
          
          
          
          <li>
            <a href="https://keybase.io/sleonard"><i class="fa fa-keybase"></i> Keybase</a>
          </li>
          
          
          
          
        </ul>
      </footer>

    </div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-148611486-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </body>
</html>

